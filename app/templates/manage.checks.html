{% extends "manage.common.html" %}

{% block action_buttons %}
<div>
    <button id="deleteSelectedBtn" style="display:none;">
        <i class="fas fa-trash me-2"></i>Delete Selected
    </button>
    <button id="exportSeletecBtn" style="display:none;">
        <i class="fas fa-file-export me-2"></i>Export Selected
    </button>
    <button id="openGitModalBtn">
        <i class="fas fa-code-branch me-2"></i>Repositories
    </button>
    <button id="openModalBtn">
        <i class="fas fa-plus-circle me-2"></i>{{ add_text }}
    </button>
</div>
{% endblock %}

{% block modals %}

<script>
    const authorName = {{ user_display_name | tojson }};
    const statusCodes = {{ status_codes | tojson }};
</script>

<!-- Include external CSS and JS for Markdown rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.1/github-markdown.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Include JavaScript for modal functionality -->
<script src="{{ url_for('static', filename='js/manage.checks.js') }}"></script>

<!-- Add Check Modal -->
<div id="modalOverlay" class="modal-overlay">
    <div class="modal" style="width: 1200px;">

        <!-- Modal Header -->
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Add Check</div>
            <button id="closeModalBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body" style="position: relative; overflow: hidden;">
            <form id="modalForm">
                <!-- Input for File Name -->
                <div class="form-grid">
                    <label>Filepath</label>
                    <input type="text" id="checkFilename" required>
                </div>

                <!-- Textarea for Python Script -->
                <div class="form-group" style="display: block; padding: 12px 0;">
                    <div class="header" style="padding-bottom: 10px;">Script (Python Code)</div>
                    <textarea id="checkCode"></textarea>
                </div>

                <!-- Modal Footer with File Browse and Generate Buttons -->
                <div class="modal-footer" style="justify-content: flex-start; border: none; padding: 0;">
                    <button type="button" id="browseFileBtn">
                        <i class="fas fa-folder-open me-1"></i>Browse
                    </button>
                    <button type="button" id="openGcModalBtn" {% if not ai_client_ready %}disabled{% endif %}>
                        <i class="fas fa-robot me-3"></i>Generate
                    </button>
                    <button type="button" id="openHelpBtn">
                        <i class="fas fa-question-circle me-2"></i>Help
                    </button>
                </div>
            </form>

            <!-- Right-Side Test Dock -->
            <div id="test-dock" class="test-dock">
                <button id="test-dock-toggle" class="test-dock-toggle">
                    <i class="fas fa-angle-left"></i>Validator
                </button>

                <div class="test-dock-content">
                    <div id="testStatus" class="badge" style="font-size: 0.85rem; padding: 10px;">Ready to begin
                        testing...
                    </div>
                    <div class="column-flex">
                        <h5 style="margin: 2px;"><span id="reqCommand"></span></h5>
                        <textarea id="testSampleOutput" style="resize: none;"
                                  placeholder="Paste sample command output here..."></textarea>
                    </div>
                    <div class="column-flex">
                        <h5 style="margin: 2px;">Results</h5>
                        <div id="testResultsBox" class="test-results" hidden>

                            <div class="result-section" style="display: flex; align-items: center; gap: 10px;">
                                <label>Status</label>
                                <span id="testStatusBadge"
                                      class="badge"
                                      title="">
                                    <i id="testStatusIcon" class="fas"></i>
                                    <span id="testStatusLabel"></span>
                                </span>
                            </div>

                            <div class="result-section">
                                <label>Observation</label>
                                <div id="testObservation" class="result-text"></div>
                            </div>

                            <div class="result-section">
                                <label>Comments</label>
                                <ul id="testComments"></ul>
                            </div>

                        </div>
                    </div>
                    <button id="runHandlerBtn" style="width:100px;"><i class="fas fa-play"></i>Validate</button>
                </div>
            </div>
        </div>

        <!-- Modal Footer with Save, Cancel and Test Toggle Button -->
        <div class="modal-footer">
            <button id="saveBtn">
                <i class="fas fa-save me-2"></i>Save
            </button>
            <button id="cancelModalBtn">
                <i class="fas fa-times me-2"></i>Cancel
            </button>
        </div>

    </div>
</div>

<!-- Git Repos Modal -->
<div id="gitModalOverlay" class="modal-overlay">
    <div class="modal" style="width: 1000px;">

        <!-- Modal Header -->
        <div class="modal-header">
            <div class="modal-title">Check Repositories</div>
            <button id="closeGitModalBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">

            <!-- Add URL Row -->
            <div class="form-grid" style="grid-template-columns: 3fr 1fr auto;">
                <input type="text" id="gitUrlInput" placeholder="Enter Git repository URL"/>
                <input type="text" id="localNameInput" placeholder="Local Folder"/>
                <button id="gitAddBtn" style="margin-left: 10px;">
                    <i class="fas fa-plus-circle ms-2"></i>Clone
                </button>
            </div>

            <hr>

            <!-- Repository Table -->
            <table id="gitReposTable" style="width: 100%;">
                <thead>
                <tr>
                    <th>Repository</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="gitReposBody">
                <!-- Will be filled by JS -->
                </tbody>
            </table>

        </div>

        <!-- Modal Footer -->
        <div class="modal-footer">
            <button id="closeGitModalBtn2">
                <i class="fas fa-times"></i> Close
            </button>
        </div>

    </div>
</div>

<!-- Generate Check Modal -->
<div id="gcModalOverlay" class="modal-overlay">
    <div id="gcModal" class="modal" style="width: 800px;">

        <!-- Modal Header -->
        <div class="modal-header">
            <h5 class="modal-title" id="gcModalTitle">Generate New Check</h5>
            <button type="button" class="action-btn" id="closeGcModalBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
            <form id="gcForm" class="form-grid">
                <!-- Textarea for Description -->
                <label>Description</label>
                <textarea id="gcDescription" style="height: 80px; resize: none;"
                          placeholder="e.g. This check verifies the NXOS version on network devices."
                          required></textarea>
                <span></span>

                <!-- Textarea for Sample output -->
                <label>Sample Output</label>
                <textarea id="gcSampleOutput" style="height: 400px; resize: none;"
                          placeholder="(Optional) Additional context for command inference, handler logic, and parsing examples"></textarea>
                <span></span>
            </form>
        </div>

        <!-- Modal Footer with Generate and Cancel Buttons -->
        <div class="modal-footer">
            <button id="saveGcBtn">
                <i class="fas fa-file-code me-2"></i>Generate
            </button>
            <button id="cancelGcModalBtn">
                <i class="fas fa-times me-2"></i>Cancel
            </button>
        </div>
    </div>
</div>

<!-- Check Help Modal -->
<div id="checkHelpOverlay" class="modal-overlay">
    <div class="modal" style="width: 1100px; height: 90vh;">

        <!-- Modal Header -->
        <div class="modal-header">
            <div class="modal-title">Help</div>
            <button id="closeCheckHelpModalBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body" style="overflow-y: auto;">
            <article id="checkHelpContent" class="markdown-body">
                Loading documentationâ€¦
            </article>
        </div>
    </div>
</div>


{% endblock %}